<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建笔记</title>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="m-0 font-newsreader bg-[#FAFAFA] text-[#1A140F]">
    <div class="max-w-[1280px] mx-auto bg-[#FAFAFA] min-h-screen flex flex-col">
        <header class="flex justify-between items-center py-3 px-10 border-b border-[#E5E8EB]">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-4">
                    <img src="assets/images/NoteNest_logo.svg" alt="NoteNest Logo" width="16" height="16">
                    <span class="font-bold text-lg leading-[1.2777777777777777em] text-[#1A140F]">NoteNest</span>
                </a>
            </div>
            <div class="flex items-center gap-8">
                <div class="bg-[#F2EDE8] rounded-[12px] w-10 h-10 flex justify-center items-center">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.5 10H2.5M10 2.5V17.5" stroke="#1A140F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="bg-[#EBC7AD] rounded-[20px] w-10 h-10 flex justify-center items-center overflow-hidden">
                    <img src="assets/images/Stitch_avatar.png" alt="User Avatar" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <main class="flex-grow px-10 py-5 flex flex-col gap-4 items-center">
            <div class="w-[90%] py-3">
                <input type="text" placeholder="Title" class="w-full p-4 border border-[#E3D9D4] rounded-[12px] bg-[#FAFAFA] text-base font-normal text-[#8F6E57] outline-none placeholder:text-[#8F6E57]">
            </div>
 
            <div id="toolbar" class="w-[90%] border border-[#E3D9D4] rounded-t-[12px] bg-[#FAFAFA] p-2 flex flex-wrap gap-1">
                <button class="ql-bold" title="加粗"></button>
                <button class="ql-italic" title="斜体"></button>
                <button class="ql-underline" title="下划线"></button>
                <button class="ql-strike" title="删除线"></button>
                <select class="ql-align" title="对齐方式"></select>
                <select class="ql-header" title="标题">
                    <option value="1">标题 1</option>
                    <option value="2">标题 2</option>
                    <option value="3">标题 3</option>
                    <option value="4">标题 4</option>
                    <option value="5">标题 5</option>
                    <option value="6">标题 6</option>
                    <option selected>正文</option>
                </select>
                <button class="ql-list" value="ordered" title="有序列表"></button>
                <button class="ql-list" value="bullet" title="无序列表"></button>
                <button class="ql-blockquote" title="引用"></button>
                <button class="ql-code-block" title="代码块"></button>
                <button class="ql-link" title="插入链接"></button>
                <button class="ql-image" title="插入图片"></button>
            </div>
            <div id="editor" class="w-[90%] h-[500px] p-4 border border-[#E3D9D4] rounded-b-[12px] bg-[#FAFAFA] text-base font-normal text-[#1A140F] outline-none"></div>
 
            <div class="w-[90%] flex justify-end gap-3 py-3">
                <button id="cancel-button" class="bg-[#F2EDE8] rounded-[12px] w-[120px] h-10 flex justify-center items-center font-bold text-sm leading-[1.5em] text-[#1A140F]">Cancel</button>
                <button id="save-update-button" class="bg-[#EBC7AD] rounded-[12px] w-[120px] h-10 flex justify-center items-center font-bold text-sm leading-[1.5em] text-[#1A140F]">Save</button>
            </div>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const titleInput = document.querySelector('input[placeholder="Title"]');
        const cancelButton = document.getElementById('cancel-button');
        const saveButton = document.getElementById('save-update-button');
 
        let currentNoteId = null; // To store the ID of the note being edited
        const API_BASE_URL = 'http://localhost:9876'; // Backend API URL
 
        // Initialize Quill editor
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: '#toolbar' // Enable Quill's default toolbar
            }
        });

        /**
         * 显示自定义模态框
         * @param {string} title - 模态框标题
         * @param {string} message - 模态框消息
         * @param {string} confirmText - 确认按钮文本
         * @param {string} cancelText - 取消按钮文本
         * @returns {Promise<boolean>} - 用户点击确认返回 true，点击取消返回 false
         */
        function showCustomModal(title, message, confirmText = '确认', cancelText = '取消') {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalConfirmBtn = document.getElementById('modal-confirm-btn');
                const modalCancelBtn = document.getElementById('modal-cancel-btn');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = confirmText;
                modalCancelBtn.textContent = cancelText;

                modal.classList.remove('hidden');

                const onConfirm = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', onConfirm);
                modalCancelBtn.addEventListener('click', onCancel);
            });
        }
 
        // Function to get query parameters from URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
 
        // Load note if ID is present in URL
        document.addEventListener('DOMContentLoaded', async () => {
            const noteId = getQueryParam('id');
            if (noteId) {
                currentNoteId = noteId;
                try {
                    const response = await fetch(`${API_BASE_URL}/note/${noteId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const noteToEdit = await response.json();
 
                    if (noteToEdit) {
                        titleInput.value = noteToEdit.title;
                        quill.setContents(noteToEdit.content); // Load Quill Delta content directly
                        document.title = `编辑笔记: ${noteToEdit.title}`; // Update page title
                        saveButton.textContent = '更新'; // Change button text to Update
                    } else {
                        await showCustomModal('错误', '未找到要编辑的笔记！', '好的');
                        window.location.href = 'index.html'; // Redirect if note not found
                    }
                } catch (error) {
                    console.error('Error loading note:', error);
                    await showCustomModal('错误', '加载笔记失败！请稍后再试。', '好的');
                    window.location.href = 'index.html';
                }
            }
        });
 
        cancelButton.addEventListener('click', () => {
            // Always go back to index.html on cancel
            window.location.href = 'index.html';
        });
 
        saveButton.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const content = quill.getContents(); // Get Quill Delta content (not stringified yet)
 
            if (title === '' || quill.getText().trim() === '') { // Check if title or content is empty
                await showCustomModal('输入错误', '标题和内容都不能为空！', '好的');
                return;
            }
 
            const noteData = {
                id: currentNoteId, // Will be null for new notes, or existing ID for updates
                title: title,
                content: content // Send Quill Delta object
            };
 
            try {
                const response = await fetch(`${API_BASE_URL}/save-note`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });
 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
 
                const result = await response.json();
                await showCustomModal('操作成功', result.message, '好的');
                window.location.href = 'index.html'; // Redirect to home page after save/update
            } catch (error) {
                console.error('Error saving note:', error);
                await showCustomModal('操作失败', '保存笔记失败！请稍后再试。', '好的');
            }
        });
    </script>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#FCFAF7] rounded-lg shadow-xl p-8 max-w-sm w-full animate-slide-down">
            <h3 id="modal-title" class="font-bold text-xl text-[#1C120D] mb-4"></h3>
            <p id="modal-message" class="font-normal text-base text-[#966E4F] mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-[#F2EDE8] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">取消</button>
                <button id="modal-confirm-btn" class="bg-[#EBC7AD] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">确认</button>
            </div>
        </div>
    </div>
</body>
</html>
