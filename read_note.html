<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看笔记</title>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Custom styles for read-only Quill editor */
        .ql-editor {
            min-height: 500px; /* Ensure enough height for content */
            padding: 16px;
            border: 1px solid #E3D9D4;
            border-radius: 12px;
            background-color: #FAFAFA;
            font-size: 1rem;
            font-weight: normal;
            color: #1A140F;
            outline: none;
        }
        .ql-container.ql-snow {
            border: none; /* Remove default Quill border */
        }
    </style>
</head>
<body class="m-0 font-newsreader bg-[#FAFAFA] text-[#1A140F]">
    <div class="max-w-[1280px] mx-auto bg-[#FAFAFA] min-h-screen flex flex-col">
        <header class="flex justify-between items-center py-3 px-10 border-b border-[#E5E8EB]">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-4">
                    <img src="assets/images/NoteNest_logo.svg" alt="NoteNest Logo" width="16" height="16">
                    <span class="font-bold text-lg leading-[1.2777777777777777em] text-[#1A140F]">NoteNest</span>
                </a>
            </div>
            <div class="flex items-center gap-8">
                <div class="bg-[#F2EDE8] rounded-[12px] w-10 h-10 flex justify-center items-center">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.5 10H2.5M10 2.5V17.5" stroke="#1A140F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="bg-[#EBC7AD] rounded-[20px] w-10 h-10 flex justify-center items-center overflow-hidden">
                    <img src="assets/images/Stitch_avatar.png" alt="User Avatar" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <main class="flex-grow px-10 py-5 flex flex-col gap-4 items-center">
            <h1 id="note-title" class="w-[90%] text-3xl font-bold text-[#1A140F] mb-4"></h1>
            <div id="note-content" class="w-[90%]"></div>
            <div class="w-[90%] flex justify-end gap-3 py-3">
                <button id="edit-button" class="bg-[#EBC7AD] rounded-[12px] w-[84px] h-10 flex justify-center items-center font-bold text-sm leading-[1.5em] text-[#1A140F]">编辑</button>
            </div>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const noteTitleElement = document.getElementById('note-title');
        const noteContentElement = document.getElementById('note-content');
        const editButton = document.getElementById('edit-button');
        const API_BASE_URL = 'http://localhost:9876'; // Backend API URL (Corrected Port)

        // Initialize Quill editor in read-only mode
        const quill = new Quill(noteContentElement, {
            theme: 'snow',
            readOnly: true,
            modules: {
                toolbar: false // No toolbar for read-only view
            }
        });

        /**
         * 显示自定义模态框
         * @param {string} title - 模态框标题
         * @param {string} message - 模态框消息
         * @param {string} confirmText - 确认按钮文本
         * @param {string} cancelText - 取消按钮文本
         * @returns {Promise<boolean>} - 用户点击确认返回 true，点击取消返回 false
         */
        function showCustomModal(title, message, confirmText = '确认', cancelText = '取消') {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalConfirmBtn = document.getElementById('modal-confirm-btn');
                const modalCancelBtn = document.getElementById('modal-cancel-btn');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = confirmText;
                modalCancelBtn.textContent = cancelText;

                modal.classList.remove('hidden');

                const onConfirm = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', onConfirm);
                modalCancelBtn.addEventListener('click', onCancel);
            });
        }
 
        // Function to get query parameters from URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
 
        // Load note if ID is present in URL
        document.addEventListener('DOMContentLoaded', async () => {
            const noteId = getQueryParam('id');
            if (noteId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/note/${noteId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const note = await response.json();
 
                    if (note) {
                        noteTitleElement.textContent = note.title;
                        quill.setContents(note.content); // Load Quill Delta content directly
                        document.title = `查看笔记: ${note.title}`; // Update page title
                        editButton.onclick = () => {
                            window.location.href = `new_note.html?id=${note.id}`;
                        };
                    } else {
                        await showCustomModal('错误', '未找到要查看的笔记！', '好的');
                        window.location.href = 'index.html'; // Redirect if note not found
                    }
                } catch (error) {
                    console.error('Error loading note:', error);
                    await showCustomModal('错误', '加载笔记失败！请稍后再试。', '好的');
                    window.location.href = 'index.html';
                }
            } else {
                await showCustomModal('错误', '未提供笔记ID！', '好的');
                window.location.href = 'index.html';
            }
        });
    </script>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#FCFAF7] rounded-lg shadow-xl p-8 max-w-sm w-full animate-slide-down">
            <h3 id="modal-title" class="font-bold text-xl text-[#1C120D] mb-4"></h3>
            <p id="modal-message" class="font-normal text-base text-[#966E4F] mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-[#F2EDE8] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">取消</button>
                <button id="modal-confirm-btn" class="bg-[#EBC7AD] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">确认</button>
            </div>
        </div>
    </div>
</body>
</html>