<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteNest 首页</title>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .animate-slide-down {
            animation: slideDown 0.7s ease-out forwards;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
    </style>
</head>
<body class="m-0 font-newsreader bg-[#FCFAF7] text-[#1C120D] relative">
    <!-- Parallax Background Layer -->

    <div class="main-content-wrapper max-w-[1280px] mx-auto bg-[#FCFAF7] min-h-screen flex flex-col shadow-lg">
        <header class="flex justify-between items-center py-3 px-10 border-b border-[#E5E8EB] bg-[#FCFAF7] sticky top-0 z-20 shadow-sm">
            <div class="flex items-center gap-4">
                <img src="assets/images/NoteNest_logo.svg" alt="NoteNest Logo" width="16" height="16" class="animate-fade-in">
                <span class="font-bold text-lg leading-[1.2777777777777777em] text-[#1C120D] animate-slide-down">NoteNest</span>
            </div>
            <nav class="flex items-center gap-9">
                <a href="index.html" class="nav-link font-medium text-sm leading-[1.5em] text-[#1C120D] no-underline relative overflow-hidden group">
                    首页
                    <span class="absolute bottom-0 left-0 w-full h-[2px] bg-[#966E4F] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                </a>
                <a href="new_note.html" class="nav-link font-medium text-sm leading-[1.5em] text-[#1C120D] no-underline relative overflow-hidden group">
                    新建笔记
                    <span class="absolute bottom-0 left-0 w-full h-[2px] bg-[#966E4F] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                </a>
                <a href="#" class="nav-link font-medium text-sm leading-[1.5em] text-[#1C120D] no-underline relative overflow-hidden group">
                    分类
                    <span class="absolute bottom-0 left-0 w-full h-[2px] bg-[#966E4F] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-out"></span>
                </a>
            </nav>
            <div class="flex items-center gap-8">
                <div class="bg-[#F2EDE8] rounded-[20px] w-10 h-10 flex justify-center items-center cursor-pointer hover:bg-[#E3D9D4] transition-colors duration-200 transform hover:rotate-12 active:scale-95">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 0C4.477 0 0 4.477 0 10C0 15.523 4.477 20 10 20C15.523 20 20 15.523 20 10C20 4.477 15.523 0 10 0ZM10 3C11.657 3 13 4.343 13 6C13 7.657 11.657 9 10 9C8.343 9 7 7.657 7 6C7 4.343 8.343 3 10 3ZM10 17.5C7.5 17.5 5.25 16.25 4 14.5C4.08 12.5 7.33 11.5 10 11.5C12.67 11.5 15.92 12.5 16 14.5C14.75 16.25 12.5 17.5 10 17.5Z" fill="#1C120D"></path>
                    </svg>
                </div>
                <div class="bg-[#F2EDE8] rounded-[20px] w-10 h-10 flex justify-center items-center overflow-hidden cursor-pointer hover:scale-110 transition-transform duration-300 shadow-md">
                    <img src="assets/images/Stitch_avatar.png" alt="User Avatar" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <main class="flex-grow px-40 py-5 flex flex-col gap-5 relative z-10">
            <div class="py-3 px-4">
                <div class="flex items-center bg-[#F2EDE8] rounded-[12px] h-12 shadow-inner focus-within:ring-2 focus-within:ring-[#966E4F] transition-all duration-300">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="ml-4 text-[#966E4F]">
                        <path d="M23.707 22.293L18.314 16.9C19.314 15.507 19.814 13.814 19.814 12.014C19.814 7.036 15.778 3 10.814 3C5.85 3 3 7.036 3 12.014C3 16.992 5.85 21.028 10.814 21.028C12.614 21.028 14.307 20.528 15.707 19.528L20.099 23.92C20.488 24.309 21.121 24.309 21.51 23.92L22.707 22.723C23.096 22.334 23.096 21.702 23.707 22.293ZM10.814 18.028C7.514 18.028 5.014 15.528 5.014 12.014C5.014 8.501 7.514 6.001 10.814 6.001C14.114 6.001 16.614 8.501 16.614 12.014C16.614 15.528 14.114 18.028 10.814 18.028Z" fill="#966E4F"/>
                    </svg>
                    <input type="text" placeholder="Search your notes" class="flex-grow border-none bg-transparent py-2 px-2 text-base font-normal text-[#966E4F] outline-none placeholder:text-[#966E4F]">
                </div>
            </div>

            <section class="py-5 px-4 pb-3">
                <h2 class="font-bold text-2xl leading-[1.2727272727272727em] text-[#1C120D] mb-4 animate-fade-in-up">Recent Notes</h2>
                <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Notes will be dynamically loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script>

        const API_BASE_URL = 'http://localhost:9876'; // Backend API URL

        function timeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const seconds = Math.floor((now - past) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) {
                return Math.floor(interval) + "年前";
            }
            interval = seconds / 2592000;
            if (interval > 1) {
                return Math.floor(interval) + "个月前";
            }
            interval = seconds / 86400;
            if (interval > 1) {
                return Math.floor(interval) + "天前";
            }
            interval = seconds / 3600;
            if (interval > 1) {
                return Math.floor(interval) + "小时前";
            }
            interval = seconds / 60;
            if (interval > 1) {
                return Math.floor(interval) + "分钟前";
            }
            return Math.floor(seconds) + "秒前";
        }

        function displayNotes(notesToDisplay) {
            const notesListDiv = document.getElementById('notes-list');
            notesListDiv.innerHTML = ''; // Clear existing notes

            if (notesToDisplay.length === 0) {
                notesListDiv.innerHTML = '<p class="text-center text-[#966E4F] col-span-full py-10">暂无笔记。点击“新建笔记”创建您的第一篇笔记吧！</p>';
                return;
            }

            notesToDisplay.forEach((note, index) => {
                const noteElement = document.createElement('div');
                noteElement.className = `note-card bg-[#FCFAF7] rounded-lg shadow-md p-6 flex flex-col justify-between transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl cursor-pointer animate-fade-in-up`;
                noteElement.style.animationDelay = `${index * 0.05}s`; // Staggered animation
                noteElement.dataset.noteId = note.id; // Store note ID for future use

                noteElement.innerHTML = `
                    <div class="flex flex-col flex-grow">
                        <div class="flex items-center mb-3">
                            <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 text-[#966E4F] flex-shrink-0">
                                <path d="M13.3333 4.66667V13.3333C13.3333 13.7015 13.1845 14.0544 12.9144 14.3245C12.6443 14.5946 12.2913 14.7434 11.9231 14.7434H4.07692C3.70873 14.7434 3.35571 14.5946 3.08561 14.3245C2.81551 14.0544 2.66667 13.7015 2.66667 13.3333V2.66667C2.66667 2.29848 2.81551 1.94546 3.08561 1.67536C3.35571 1.40526 3.70873 1.25642 4.07692 1.25642H9.33333L13.3333 4.66667ZM11.9231 13.3333V5.33333H9.33333C8.96514 5.33333 8.61212 5.18449 8.34202 4.91439C8.07192 4.64429 7.92308 4.29127 7.92308 3.92308V1.25642H4.07692V13.3333H11.9231ZM6.66667 7.33333H5.33333V8.66667H6.66667V7.33333ZM10.6667 7.33333H8V8.66667H10.6667V7.33333ZM10.6667 10H8V11.3333H10.6667V10ZM6.66667 10H5.33333V11.3333H6.66667V10Z" fill="#966E4F"/>
                            </svg>
                            <h3 class="font-bold text-lg leading-[1.3em] text-[#1C120D] truncate">${note.title}</h3>
                        </div>
                        <p class="font-normal text-sm leading-[1.6em] text-[#966E4F] mb-4 flex-grow overflow-hidden text-ellipsis">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</p>
                    </div>
                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-[#E5E8EB]">
                        <span class="font-normal text-xs leading-[1.5em] text-[#966E4F]">${timeAgo(note.timestamp)}</span>
                        <div class="flex gap-2">
                            <button class="edit-note-btn bg-[#EBC7AD] text-[#1A140F] px-3 py-1 rounded-md text-xs font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">编辑</button>
                            <button class="delete-note-btn bg-[#F2EDE8] text-[#1A140F] px-3 py-1 rounded-md text-xs font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">删除</button>
                        </div>
                    </div>
                `;
                notesListDiv.appendChild(noteElement);

                // Add event listeners for edit and delete buttons
                noteElement.querySelector('.edit-note-btn').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent the note click event from firing
                    editNote(note.id);
                });

                noteElement.querySelector('.delete-note-btn').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent the note click event from firing
                    deleteNote(note.id);
                });

                // Add click event listener to the note element itself (excluding button clicks)
                noteElement.addEventListener('click', () => {
                    window.location.href = `read_note.html?id=${note.id}`;
                });
            });
        }

        /**
         * 显示自定义模态框
         * @param {string} title - 模态框标题
         * @param {string} message - 模态框消息
         * @param {string} confirmText - 确认按钮文本
         * @param {string} cancelText - 取消按钮文本
         * @returns {Promise<boolean>} - 用户点击确认返回 true，点击取消返回 false
         */
        function showCustomModal(title, message, confirmText = '确认', cancelText = '取消') {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalConfirmBtn = document.getElementById('modal-confirm-btn');
                const modalCancelBtn = document.getElementById('modal-cancel-btn');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = confirmText;
                modalCancelBtn.textContent = cancelText;

                modal.classList.remove('hidden');

                const onConfirm = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    modal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', onConfirm);
                modalCancelBtn.addEventListener('click', onCancel);
            });
        }

        /**
         * 删除笔记
         * @param {string} id - 笔记ID
         */
        async function deleteNote(id) {
            const confirmed = await showCustomModal(
                '删除笔记',
                '您确定要删除这篇笔记吗？此操作不可撤销。',
                '删除',
                '取消'
            );

            if (confirmed) {
                try {
                    const response = await fetch(`${API_BASE_URL}/delete-note/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    await showCustomModal('操作成功', result.message, '好的');
                    loadAndFilterNotes(); // Reload notes after deletion
                } catch (error) {
                    console.error('Error deleting note:', error);
                    await showCustomModal('操作失败', '删除笔记失败！请稍后再试。', '好的');
                }
            }
        }

        function editNote(id) {
            // Redirect to new_note.html with the note ID as a query parameter
            window.location.href = `new_note.html?id=${id}`;
        }

        async function loadAndFilterNotes() {
            const searchTerm = searchInput.value.toLowerCase();
            try {
                const response = await fetch(`${API_BASE_URL}/notes`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                let notes = await response.json();

                const filteredNotes = notes.filter(note =>
                    note.title.toLowerCase().includes(searchTerm) ||
                    note.content.toLowerCase().includes(searchTerm)
                );

                displayNotes(filteredNotes);
            } catch (error) {
                console.error('Error loading notes:', error);
                // If backend is not running or fails, display a message
                const notesListDiv = document.getElementById('notes-list');
                notesListDiv.innerHTML = '<p class="text-center text-red-500">无法加载笔记。请确保后端服务正在运行。</p>';
            }
        }

        const searchInput = document.querySelector('input[placeholder="Search your notes"]');
        searchInput.addEventListener('input', loadAndFilterNotes);

        // Initial load of notes when the page loads
        document.addEventListener('DOMContentLoaded', loadAndFilterNotes);
    </script>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#FCFAF7] rounded-lg shadow-xl p-8 max-w-sm w-full animate-slide-down">
            <h3 id="modal-title" class="font-bold text-xl text-[#1C120D] mb-4"></h3>
            <p id="modal-message" class="font-normal text-base text-[#966E4F] mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-[#F2EDE8] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">取消</button>
                <button id="modal-confirm-btn" class="bg-[#EBC7AD] text-[#1A140F] px-5 py-2 rounded-md text-sm font-bold hover:opacity-80 transition-opacity duration-200 transform hover:scale-105 active:scale-95">确认</button>
            </div>
        </div>
    </div>
</body>
</html>
